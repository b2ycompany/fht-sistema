rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funções Auxiliares (sem alterações) ---
    function isSignedIn() { return request.auth != null; }
    function hasRole(role) { return isSignedIn() && request.auth.token.role == role; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isUnitManager(unitId) { return hasRole('hospital') && request.auth.uid == unitId; }
    function isStaffMember(unitId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.hospitalId == unitId;
    }

    // --- REGRAS PARA UTILIZADORES (sem alterações) ---
    match /users/{userId} {
      allow read: if hasRole('admin') || isOwner(userId) || isUnitManager(resource.data.hospitalId);
      allow create: if isOwner(userId) || hasRole('admin');
      allow update: if isOwner(userId) || hasRole('admin');
      allow delete: if hasRole('admin');
    }
    
    // --- REGRAS PARA O FLUXO DE ATENDIMENTO (sem alterações) ---
    match /patients/{patientId} {
      allow read, write: if hasRole('admin') || isStaffMember(resource.data.unitId) || isUnitManager(resource.data.unitId);
      allow delete: if hasRole('admin');
    }
    match /serviceQueue/{queueId} {
      allow read, write: if hasRole('admin') || isUnitManager(resource.data.unitId) || isStaffMember(resource.data.unitId);
      allow delete: if hasRole('admin');
    }
    match /consultations/{consultationId} {
      allow read, write: if hasRole('admin') || isOwner(resource.data.doctorId) || isUnitManager(resource.data.hospitalId);
      allow delete: if hasRole('admin');
    }
    
    // --- REGRAS DE NEGÓCIO (COM CORREÇÕES PARA A AGENDA) ---
    match /settings/{settingId} { allow read, write: if hasRole('admin'); }

    match /contracts/{contractId} {
      // Regra existente para ler/escrever um documento específico
      allow read, write: if hasRole('admin') || (isSignedIn() && (resource.data.doctorId == request.auth.uid || resource.data.hospitalId == request.auth.uid));
      
      // REGRA ADICIONADA: Permite que um médico liste (leia múltiplos) contratos
      // onde o seu ID de utilizador corresponda ao campo 'doctorId'.
      allow list: if hasRole('admin') || (hasRole('doctor') && request.query.doctorId == request.auth.uid);
    }

    match /specialties/{specialtyId} { allow read: if true; allow write: if hasRole('admin'); }
    match /invitations/{invitationId} { allow create: if hasRole('admin') || hasRole('hospital'); allow read, update, delete: if false; }
    match /caravanEvents/{eventId} { allow read: if isSignedIn(); allow write: if hasRole('admin'); }
    match /shiftRequirements/{requirementId} { allow read: if isSignedIn(); allow create: if hasRole('admin') || (hasRole('hospital') && request.resource.data.hospitalId == request.auth.uid); allow update, delete: if hasRole('admin') || (isSignedIn() && resource.data.hospitalId == request.auth.uid); }
    match /timeRecords/{recordId} { allow read: if hasRole('admin') || (isSignedIn() && (resource.data.doctorId == request.auth.uid || resource.data.hospitalId == request.auth.uid)); allow write: if hasRole('admin') || (isSignedIn() && request.auth.uid == resource.data.doctorId); }

    match /doctorTimeSlots/{timeSlotId} {
      // Regra existente para manipular um documento específico
      allow read, write, delete: if hasRole('admin') || (isSignedIn() && resource.data.doctorId == request.auth.uid);
      
      // REGRA ADICIONADA: Permite que um médico liste os seus próprios horários
      // disponíveis, essencial para montar a agenda.
      allow list: if hasRole('admin') || (hasRole('doctor') && request.query.doctorId == request.auth.uid);
    }

    match /appointments/{appointmentId} {
      // Regra existente para ler um agendamento específico
      allow read: if hasRole('admin') || (isSignedIn() && resource.data.doctorId == request.auth.uid);
      
      // REGRA ADICIONADA: Permite que um médico liste os seus próprios agendamentos
      // para visualização na agenda.
      allow list: if hasRole('admin') || (hasRole('doctor') && request.query.doctorId == request.auth.uid);
    }

    match /potentialMatches/{matchId} { 
      allow read, write: if hasRole('admin') || (isSignedIn() && (resource.data.doctorId == request.auth.uid || resource.data.hospitalId == request.auth.uid)); 
      allow delete: if hasRole('admin');
    }
  }
}