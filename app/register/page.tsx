// app/register/page.tsx
"use client";

import React from "react";
import { useState, useMemo, ChangeEvent, useEffect, useCallback } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { useIMask } from 'react-imask';
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Switch } from "@/components/ui/switch";
import { Textarea } from "@/components/ui/textarea";
import { useToast } from "@/hooks/use-toast";
import {
    registerUser,
    type UserType,
    type DoctorRegistrationPayload,
    type HospitalRegistrationPayload,
    type AddressInfo,
    type PersonalInfo,
    type LegalRepresentativeInfo,
    type DoctorDocumentsRef,
    type SpecialistDocumentsRef,
    type HospitalDocumentsRef,
    type LegalRepDocumentsRef
} from "@/lib/auth-service";
import { FirebaseError } from "firebase/app";
import { cn } from "@/lib/utils";
import { Loader2, Check, AlertTriangle, Info, Stethoscope, Building } from "lucide-react";

// --- Tipos Locais ---
interface Credentials { password: string; confirmPassword: string; }
interface HospitalInfo { companyName: string; cnpj: string; stateRegistration?: string; phone: string; email: string;}
interface DoctorDocumentsState { personalRg: File | null; personalCpf: File | null; professionalCrm: File | null; photo3x4: File | null; addressProof: File | null; graduationCertificate: File | null; criminalRecordCert: File | null; ethicalCert: File | null; debtCert: File | null; cv: File | null; }
interface SpecialistDocumentsState { rqe: File | null; postGradCert: File | null; specialistTitle: File | null; recommendationLetter: File | null; }
interface HospitalDocumentsState { socialContract: File | null; cnpjCard: File | null; companyAddressProof: File | null; }
interface LegalRepDocumentsState { repRg: File | null; repCpf: File | null; repAddressProof: File | null; }

const DOCUMENT_LABELS = { personalRg: "RG Pessoal*", personalCpf: "CPF Pessoal*", professionalCrm: "Carteira Profissional (CRM)*", photo3x4: "Foto 3x4 Recente*", addressProof: "Comprovante de Residência Pessoal*", graduationCertificate: "Certificado de Graduação*", criminalRecordCert: "Certidão Negativa Criminal*", ethicalCert: "Certidão Negativa Ético-Profissional*", debtCert: "Certidão Negativa de Débitos CRM*", cv: "Currículo Vitae (CV)*", rqe: "Registro de Qualificação de Especialista (RQE)*", postGradCert: "Certificado de Pós-Graduação/Residência*", specialistTitle: "Título de Especialista*", recommendationLetter: "Carta de Recomendação (Opcional)", socialContract: "Contrato Social*", cnpjCard: "Cartão CNPJ*", companyAddressProof: "Comprovante de Endereço da Empresa*", repRg: "RG do Responsável*", repCpf: "CPF do Responsável*", repAddressProof: "Comprovante de Residência do Responsável*", } as const;
type DoctorDocKeys = keyof DoctorDocumentsState; type SpecialistDocKeys = keyof SpecialistDocumentsState; type HospitalDocKeys = keyof HospitalDocumentsState; type LegalRepDocKeys = keyof LegalRepDocumentsState; type AllDocumentKeys = keyof typeof DOCUMENT_LABELS;

// --- Step Indicator Component ---
interface StepIndicatorProps { steps: string[]; currentStep: number; }
const StepIndicator: React.FC<StepIndicatorProps> = ({ steps, currentStep }) => {
    return ( <div className="flex items-center justify-between mb-8 relative max-w-full overflow-x-auto pb-2"> <div className="absolute top-4 left-0 right-0 h-0.5 bg-gray-300 transform -translate-y-1/2 -z-10" style={{ width: `calc(100% - ${100 / (steps.length || 1)}%)`, margin: '0 auto' }}> <div className="h-full bg-blue-600 transition-all duration-300 ease-in-out" style={{ width: `${(currentStep / Math.max(1, steps.length - 1)) * 100}%` }} /> </div> {steps.map((label, index) => ( <div key={label + index} className="flex flex-col items-center z-10 min-w-[60px] px-1"> <div className={cn("w-7 h-7 rounded-full flex items-center justify-center text-xs font-medium transition-colors duration-300 border-2", index === currentStep ? "bg-blue-600 text-white border-blue-700 ring-2 ring-offset-2 ring-blue-600" : index < currentStep ? "bg-blue-600 text-white border-blue-700" : "bg-gray-200 text-gray-600 border-gray-300")}> {index < currentStep ? <Check size={14} /> : index + 1} </div> <span className={cn("text-[10px] sm:text-xs mt-1.5 text-center max-w-[70px] break-words leading-tight", index <= currentStep ? "text-blue-700 font-medium" : "text-gray-500")}>{label}</span> </div> ))} </div> );
};

// --- Registration Summary Component ---
type SummaryData = { personalInfo?: PersonalInfo; addressInfo?: AddressInfo; doctorDocuments?: DoctorDocumentsState; isSpecialist?: boolean; specialistDocuments?: SpecialistDocumentsState; hospitalInfo?: HospitalInfo; hospitalAddressInfo?: AddressInfo; hospitalDocuments?: HospitalDocumentsState; legalRepresentativeInfo?: LegalRepresentativeInfo; legalRepDocuments?: LegalRepDocumentsState; credentials?: Partial<Credentials>; };
interface RegistrationSummaryProps { role: UserType; data: SummaryData; onEdit: (stepId: string) => void; }
const SummaryField: React.FC<{ label: string; value: string | undefined | null }> = ({ label, value }) => { if (!value && value !== "" ) return null; return ( <p className="text-sm"><strong className="font-medium text-gray-700">{label}:</strong> <span className="text-gray-600 ml-1 break-words">{value || <span className="italic text-gray-400">Não preenchido</span>}</span></p> ); };
const SummaryFileField: React.FC<{ label: string; file: File | null }> = ({ label, file }) => { return ( <p className="text-sm"><strong className="font-medium text-gray-700">{label.replace('*', '')}:</strong> <span className={`text-xs ml-1 ${file ? 'text-green-700 font-medium truncate max-w-[150px] inline-block align-middle' : 'text-gray-500 italic'}`} title={file?.name}>{file ? file.name : "Não enviado"}</span></p> ); };

const RegistrationSummary: React.FC<RegistrationSummaryProps> = ({ role, data, onEdit }) => {
    console.log("[RegistrationSummary] Rendering. Role:", role, "Data:", data ? Object.keys(data) : "null/undefined");
    if (!role || !data || Object.keys(data).length === 0) {
        console.warn("[RegistrationSummary] Dados insuficientes para renderizar o sumário completo. Role:", role, "Data:", data);
        return ( <div className="p-4 border-2 border-dashed border-yellow-400 bg-yellow-50 rounded-md"> <h2 className="text-xl font-bold text-center text-yellow-700 mb-4">Problema ao Carregar Revisão</h2> <p className="text-sm text-yellow-600 text-center"> Não foi possível carregar todos os detalhes para revisão. Por favor, tente voltar e avançar novamente ou contate o suporte se o problema persistir. </p> <p className="text-xs text-center mt-2">Debug: Role - {role || "N/A"}, Dados - {data ? "Presentes" : "Ausentes"}</p> </div> );
    }
    const renderSection = (title: string, stepId: string, children: React.ReactNode) => ( <div className="mb-4 p-4 border border-gray-200 rounded-lg shadow-sm bg-white relative"> <Button variant="outline" size="sm" onClick={() => onEdit(stepId)} className="absolute top-2 right-2 text-xs h-6 px-2 z-10">Editar</Button> <h3 className="text-base font-semibold mb-3 text-gray-800 border-b pb-1.5">{title}</h3> <div className="space-y-1.5">{children}</div> </div> );
    const formatDoc = (value: string | undefined, type: 'cpf' | 'cnpj' | 'phone' | 'cep' | 'rg') => { if (!value) return value; const cleanValue = value.replace(/[^\dX]/gi, ''); if (type === 'cpf' && cleanValue.length === 11) return cleanValue.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'); if (type === 'cnpj' && cleanValue.length === 14) return cleanValue.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5'); if (type === 'phone') { return cleanValue.length > 10 ? cleanValue.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3') : cleanValue.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3'); } if (type === 'cep' && cleanValue.length === 8) return cleanValue.replace(/(\d{5})(\d{3})/, '$1-$2'); if (type === 'rg') { return value; } return value; };
    return ( <div className="space-y-4 bg-gray-50 p-4 sm:p-6 rounded-lg animate-fade-in"> <h2 className="text-xl sm:text-2xl font-bold text-center text-gray-800 mb-4 sm:mb-6">Revise seus Dados</h2> {role === 'doctor' && data.personalInfo && data.addressInfo && data.doctorDocuments && data.credentials && ( <> {renderSection("Dados Pessoais", "personalInfo", (<> <SummaryField label="Nome" value={data.personalInfo.name} /> <SummaryField label="Nascimento" value={data.personalInfo.dob} /> <SummaryField label="RG" value={data.personalInfo.rg} /> <SummaryField label="CPF" value={formatDoc(data.personalInfo.cpf, 'cpf')} /> <SummaryField label="Telefone" value={formatDoc(data.personalInfo.phone, 'phone')} /> <SummaryField label="Email (Login)" value={data.personalInfo.email} /> </>))} {renderSection("Endereço Pessoal", "addressInfo", (<> <SummaryField label="CEP" value={formatDoc(data.addressInfo.cep, 'cep')} /> <SummaryField label="Rua" value={data.addressInfo.street} /> <SummaryField label="Número" value={data.addressInfo.number} /> <SummaryField label="Compl." value={data.addressInfo.complement} /> <SummaryField label="Bairro" value={data.addressInfo.neighborhood} /> <SummaryField label="Cidade" value={data.addressInfo.city} /> <SummaryField label="Estado" value={data.addressInfo.state} /> </>))} {data.doctorDocuments && renderSection("Documentos Essenciais", "essentialDocs", (<> {(Object.keys(data.doctorDocuments) as DoctorDocKeys[]).filter(k => DOCUMENT_LABELS[k].includes('*') && ['personalRg','personalCpf','professionalCrm','addressProof','graduationCertificate','photo3x4'].includes(k)).map(key => (<SummaryFileField key={key} label={DOCUMENT_LABELS[key]} file={data.doctorDocuments![key]} />))} </>))} {data.doctorDocuments && renderSection("Certidões e CV", "certsAndCvDocs", (<> {(Object.keys(data.doctorDocuments) as DoctorDocKeys[]).filter(k => ['criminalRecordCert','ethicalCert','debtCert','cv'].includes(k)).map(key => (<SummaryFileField key={key} label={DOCUMENT_LABELS[key]} file={data.doctorDocuments![key]} />))} </>))} {renderSection("Especialidade", "isSpecialist", (<p className="text-sm"><strong className="font-medium">É especialista com RQE?</strong> <span className="ml-1">{data.isSpecialist ? "Sim" : "Não"}</span></p>))} {data.isSpecialist && data.specialistDocuments && renderSection("Docs Especialista", "specialistDocs", (<> {(Object.keys(data.specialistDocuments) as SpecialistDocKeys[]).map(key => (<SummaryFileField key={key} label={DOCUMENT_LABELS[key]} file={data.specialistDocuments![key]} />))} </>))} {renderSection("Credenciais de Acesso", "credentials", (<> <SummaryField label="Email Acesso" value={data.personalInfo.email} /> <p className="text-sm"><strong className="font-medium">Senha:</strong> <span className="ml-1">********</span></p> </>))} </> )} {role === 'hospital' && data.hospitalInfo && data.hospitalAddressInfo && data.hospitalDocuments && data.legalRepresentativeInfo && data.legalRepDocuments && data.credentials && ( <> {renderSection("Dados da Empresa", "hospitalInfo", (<> <SummaryField label="Razão Social" value={data.hospitalInfo.companyName} /> <SummaryField label="CNPJ" value={formatDoc(data.hospitalInfo.cnpj, 'cnpj')} /> <SummaryField label="Insc. Estadual" value={data.hospitalInfo.stateRegistration} /> <SummaryField label="Telefone" value={formatDoc(data.hospitalInfo.phone, 'phone')} /> <SummaryField label="Email (Login)" value={data.hospitalInfo.email} /> </>))} {renderSection("Endereço da Empresa", "hospitalAddress", (<> <SummaryField label="CEP" value={formatDoc(data.hospitalAddressInfo.cep, 'cep')} /> <SummaryField label="Rua" value={data.hospitalAddressInfo.street} /> <SummaryField label="Número" value={data.hospitalAddressInfo.number} /> <SummaryField label="Compl." value={data.hospitalAddressInfo.complement} /> <SummaryField label="Bairro" value={data.hospitalAddressInfo.neighborhood} /> <SummaryField label="Cidade" value={data.hospitalAddressInfo.city} /> <SummaryField label="Estado" value={data.hospitalAddressInfo.state} /> </>))} {data.hospitalDocuments && renderSection("Documentos da Empresa", "hospitalDocs", (<> {(Object.keys(data.hospitalDocuments) as HospitalDocKeys[]).map(key => (<SummaryFileField key={key} label={DOCUMENT_LABELS[key]} file={data.hospitalDocuments![key]} />))} </>))} {renderSection("Responsável Legal", "legalRepInfo", (<> <SummaryField label="Nome" value={data.legalRepresentativeInfo.name} /> <SummaryField label="Nascimento" value={data.legalRepresentativeInfo.dob} /> <SummaryField label="RG" value={data.legalRepresentativeInfo.rg} /> <SummaryField label="CPF" value={formatDoc(data.legalRepresentativeInfo.cpf, 'cpf')} /> <SummaryField label="Telefone" value={formatDoc(data.legalRepresentativeInfo.phone, 'phone')} /> <SummaryField label="Email Pessoal" value={data.legalRepresentativeInfo.email} /> <SummaryField label="Cargo" value={data.legalRepresentativeInfo.position} /> </>))} {data.legalRepDocuments && renderSection("Documentos do Responsável", "legalRepDocs", (<> {(Object.keys(data.legalRepDocuments) as LegalRepDocKeys[]).map(key => (<SummaryFileField key={key} label={DOCUMENT_LABELS[key]} file={data.legalRepDocuments![key]} />))} </>))} {renderSection("Credenciais de Acesso", "credentials", (<> <SummaryField label="Email Acesso (Empresa)" value={data.hospitalInfo.email} /> <p className="text-sm"><strong className="font-medium">Senha:</strong> <span className="ml-1">********</span></p> </>))} </> )} <p className="text-center text-sm text-gray-600 mt-4">Confira todas as informações antes de finalizar o cadastro.</p> </div> );
};

interface InputWithIMaskProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'onAccept' | 'value' | 'defaultValue'> { maskOptions: any; onAccept: (value: string, maskRef: any) => void; defaultValue?: string; }
const InputWithIMask: React.FC<InputWithIMaskProps> = ({ maskOptions, onAccept, id, defaultValue, ...rest }) => { const { ref } = useIMask(maskOptions, { onAccept }); return <Input ref={ref as React.RefObject<HTMLInputElement>} id={id} defaultValue={defaultValue} {...rest} />; };

export default function RegisterPage() {
    const [step, setStep] = useState(0);
    const [role, setRole] = useState<UserType | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isUploading, setIsUploading] = useState(false);
    const router = useRouter();
    const { toast } = useToast();

    const [personalInfo, setPersonalInfo] = useState<PersonalInfo>({ name: "", dob: "", rg: "", cpf: "", phone: "", email: "" });
    const [addressInfo, setAddressInfo] = useState<AddressInfo>({ cep: "", street: "", number: "", complement: "", neighborhood: "", city: "", state: "" });
    const [doctorDocuments, setDoctorDocuments] = useState<DoctorDocumentsState>({ personalRg: null, personalCpf: null, professionalCrm: null, photo3x4: null, addressProof: null, graduationCertificate: null, criminalRecordCert: null, ethicalCert: null, debtCert: null, cv: null });
    const [isSpecialist, setIsSpecialist] = useState<boolean>(false);
    const [specialistDocuments, setSpecialistDocuments] = useState<SpecialistDocumentsState>({ rqe: null, postGradCert: null, specialistTitle: null, recommendationLetter: null });
    const [hospitalInfo, setHospitalInfo] = useState<HospitalInfo>({ companyName: "", cnpj: "", stateRegistration: "", phone: "", email: ""});
    const [hospitalAddressInfo, setHospitalAddressInfo] = useState<AddressInfo>({ cep: "", street: "", number: "", complement: "", neighborhood: "", city: "", state: "" });
    const [hospitalDocuments, setHospitalDocuments] = useState<HospitalDocumentsState>({ socialContract: null, cnpjCard: null, companyAddressProof: null });
    const [legalRepresentativeInfo, setLegalRepresentativeInfo] = useState<LegalRepresentativeInfo>({ name: "", dob: "", rg: "", cpf: "", phone: "", email: "", position: "" });
    const [legalRepDocuments, setLegalRepDocuments] = useState<LegalRepDocumentsState>({ repRg: null, repCpf: null, repAddressProof: null });
    const [credentials, setCredentials] = useState<Credentials>({ password: "", confirmPassword: "" });

    const stepsConfig = useMemo(() => { if (!role) return [{ id: 'role', label: 'Tipo' }]; if (role === 'hospital') { return [ { id: 'role', label: 'Tipo' }, { id: 'hospitalInfo', label: 'Dados Empresa' }, { id: 'hospitalAddress', label: 'Endereço Empresa' }, { id: 'hospitalDocs', label: 'Docs Empresa' }, { id: 'legalRepInfo', label: 'Responsável' }, { id: 'legalRepDocs', label: 'Docs Responsável' }, { id: 'credentials', label: 'Senha' }, { id: 'summary', label: 'Revisão' } ]; } const doctorBaseSteps = [ { id: 'role', label: 'Tipo' }, { id: 'personalInfo', label: 'Dados Pessoais' }, { id: 'addressInfo', label: 'Endereço' }, { id: 'essentialDocs', label: 'Docs Essenciais' }, { id: 'certsAndCvDocs', label: 'Certidões/CV' }, { id: 'isSpecialist', label: 'Especialidade?' } ]; const specialistStep = isSpecialist ? [{ id: 'specialistDocs', label: 'Docs Especialista' }] : []; const finalSteps = [ { id: 'credentials', label: 'Senha' }, { id: 'summary', label: 'Revisão' } ]; return [...doctorBaseSteps, ...specialistStep, ...finalSteps]; }, [role, isSpecialist]);
    const currentStepIndex = step;
    const currentStepConfig = stepsConfig[currentStepIndex];
    const totalSteps = stepsConfig.length;

    useEffect(() => { console.log(`[RegisterPage] Step Changed. Current Index: ${currentStepIndex}, Config ID: ${currentStepConfig?.id}, Label: ${currentStepConfig?.label}, Total Steps: ${totalSteps}`); }, [currentStepIndex, currentStepConfig, totalSteps]);

    const isValidEmail = (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    const isValidCPF = (cpf: string) => /^\d{11}$/.test(cpf.replace(/[^\d]/g, ""));
    const isValidCNPJ = (cnpj: string) => /^\d{14}$/.test(cnpj.replace(/[^\d]/g, ""));
    const isValidCEP = (cep: string) => /^\d{8}$/.test(cep.replace(/[^\d]/g, ""));
    const isValidPhone = (phone: string) => /^\d{10,11}$/.test(phone.replace(/[^\d]/g, ""));
    const isValidRG = (rg: string) => !!rg && rg.replace(/[^\dX.-]/gi, '').length >= 5;
    const isValidDate = (date: string) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(Date.parse(date)) && new Date(date) < new Date();
    const isValidPassword = (password: string) => password.length >= 6;
    const isNotEmpty = (value: string | undefined | null) => !!value && value.trim().length > 0;
    const isFilePresent = (file: File | null) => file !== null;

    const handleInputChange = useCallback(( e: ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>, setState: React.Dispatch<React.SetStateAction<any>>, field: string ) => { setState((prev: any) => ({ ...prev, [field]: e.target.value })); }, []);
    const handleIMaskAccept = useCallback(( value: string, maskRef: any, setState: React.Dispatch<React.SetStateAction<any>>, field: string ) => { setState((prev: any) => ({ ...prev, [field]: value.replace(/[^\d]/g, "") })); }, []);

    const handleFileChange = useCallback(( e: ChangeEvent<HTMLInputElement>, docKey: AllDocumentKeys ) => {
        const file = e.target.files ? e.target.files[0] : null;
        if (!file) { console.log(`[RegisterPage] File cleared for ${docKey}`); return; }
        const maxSizeMB = 5;
        if (file.size > maxSizeMB * 1024 * 1024) { toast({ variant: "destructive", title: "Arquivo Muito Grande", description: `O limite de tamanho para cada arquivo é de ${maxSizeMB}MB.` }); e.target.value = ''; return; }
        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
        if (!allowedTypes.includes(file.type)) { toast({ variant: "destructive", title: "Tipo de Arquivo Inválido", description: `Tipos aceitos: PDF, JPG, JPEG, PNG.` }); e.target.value = ''; return; }

        if (docKey in doctorDocuments) setDoctorDocuments((prev: DoctorDocumentsState) => ({ ...prev, [docKey as DoctorDocKeys]: file }));
        else if (docKey in specialistDocuments) setSpecialistDocuments((prev: SpecialistDocumentsState) => ({ ...prev, [docKey as SpecialistDocKeys]: file }));
        else if (docKey in hospitalDocuments) setHospitalDocuments((prev: HospitalDocumentsState) => ({ ...prev, [docKey as HospitalDocKeys]: file }));
        else if (docKey in legalRepDocuments) setLegalRepDocuments((prev: LegalRepDocumentsState) => ({ ...prev, [docKey as LegalRepDocKeys]: file }));
        else console.warn(`[RegisterPage] Chave de documento desconhecida ao tentar atualizar estado: ${docKey}`);
        console.log(`[RegisterPage] File changed for ${docKey}:`, file ? file.name : "No file");
    }, [toast, doctorDocuments, specialistDocuments, hospitalDocuments, legalRepDocuments]);

    const getFileFromState = useCallback((docKey: AllDocumentKeys): File | null => {
        if (docKey in doctorDocuments) return doctorDocuments[docKey as DoctorDocKeys];
        if (docKey in specialistDocuments) return specialistDocuments[docKey as SpecialistDocKeys];
        if (docKey in hospitalDocuments) return hospitalDocuments[docKey as HospitalDocKeys];
        if (docKey in legalRepDocuments) return legalRepDocuments[docKey as LegalRepDocKeys];
        return null;
    }, [doctorDocuments, specialistDocuments, hospitalDocuments, legalRepDocuments]);

    const renderFileName = (file: File | null) => { if (!file) return <span className="text-xs text-gray-500 italic ml-2">Nenhum arquivo</span>; return <span className="text-xs text-green-700 font-medium ml-2 truncate max-w-[150px] inline-block align-middle" title={file.name}>{file.name}</span>; };
    const renderFileInput = useCallback((docKey: AllDocumentKeys) => { const labelText = DOCUMENT_LABELS[docKey]; const file = getFileFromState(docKey); const inputId = `file-${docKey}`; const isRequired = labelText.includes('*'); const cleanLabel = labelText.replace('*',''); return ( <div key={docKey} className="space-y-1"> <Label htmlFor={inputId} className={cn("text-sm font-medium flex items-center")}> {cleanLabel} {isRequired && <span className="text-red-500 ml-1">*</span>} {renderFileName(file)} </Label> <Input id={inputId} type="file" key={inputId + (file ? '-selected' : '-empty')} onChange={(e) => handleFileChange(e, docKey)} className={cn( "block w-full text-sm text-gray-500 cursor-pointer", "file:mr-4 file:py-1.5 file:px-3 file:rounded-md file:border-0", "file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700", "hover:file:bg-blue-100" )} accept=".pdf,.jpg,.jpeg,.png" /> </div> ); }, [getFileFromState, handleFileChange]);

    const handleEditStep = useCallback((stepId: string) => {
        console.log(`[RegisterPage] handleEditStep called for stepId: ${stepId}`);
        const stepIndex = stepsConfig.findIndex(s => s.id === stepId);
        if (stepIndex !== -1) {
            setStep(stepIndex);
        } else {
            console.warn(`[RegisterPage] Etapa de edição não encontrada: ${stepId}. Voltando para a primeira etapa editável.`);
            setStep(1);
        }
    }, [stepsConfig]);

    const handleNextStep = useCallback(() => {
        console.log(`[RegisterPage] handleNextStep called. Current step ID: ${currentStepConfig?.id}`);
        let isValid = true;
        let errorTitle = "Campos Inválidos";
        let errorDescription = "Por favor, revise os campos destacados ou obrigatórios.";

        const validate = (condition: boolean, message?: string) => { if (!condition) { isValid = false; if (message && errorDescription === "Por favor, revise os campos destacados ou obrigatórios.") { errorDescription = message; } } return condition; };

        switch (currentStepConfig?.id) {
            case 'personalInfo': validate(isNotEmpty(personalInfo.name), "Nome completo é obrigatório."); validate(isValidDate(personalInfo.dob), "Data de nascimento inválida."); validate(isValidRG(personalInfo.rg), "RG inválido."); validate(isValidCPF(personalInfo.cpf), "CPF inválido. Insira apenas números."); validate(isValidPhone(personalInfo.phone), "Telefone inválido. Insira DDD + número."); validate(isValidEmail(personalInfo.email), "Email de login inválido."); break;
            case 'addressInfo': validate(isValidCEP(addressInfo.cep), "CEP inválido."); validate(isNotEmpty(addressInfo.street), "Rua é obrigatória."); validate(isNotEmpty(addressInfo.number), "Número é obrigatório."); validate(isNotEmpty(addressInfo.neighborhood), "Bairro é obrigatório."); validate(isNotEmpty(addressInfo.city), "Cidade é obrigatória."); validate(isNotEmpty(addressInfo.state) && addressInfo.state.length === 2, "UF inválido (use 2 letras)."); break;
            case 'essentialDocs': const essentialDocKeys: DoctorDocKeys[] = ['personalRg', 'personalCpf', 'professionalCrm', 'addressProof', 'graduationCertificate', 'photo3x4']; validate(!essentialDocKeys.some(key => !isFilePresent(doctorDocuments[key])), "Todos os documentos essenciais são obrigatórios."); break;
            case 'certsAndCvDocs': const certDocKeys: DoctorDocKeys[] = ['criminalRecordCert', 'ethicalCert', 'debtCert', 'cv']; validate(!certDocKeys.some(key => !isFilePresent(doctorDocuments[key])), "Todas as certidões e o CV são obrigatórios."); break;
            case 'isSpecialist': break;
            case 'specialistDocs': if (isSpecialist) { const specialistDocKeys: SpecialistDocKeys[] = ['rqe', 'postGradCert', 'specialistTitle']; validate(!specialistDocKeys.some(key => !isFilePresent(specialistDocuments[key])), "Documentos de especialista (RQE, Certificado de Pós, Título) são obrigatórios se você se declarou especialista."); } break;
            case 'hospitalInfo': validate(isNotEmpty(hospitalInfo.companyName), "Razão Social é obrigatória."); validate(isValidCNPJ(hospitalInfo.cnpj), "CNPJ inválido. Insira apenas números."); validate(isValidPhone(hospitalInfo.phone), "Telefone da empresa inválido."); validate(isValidEmail(hospitalInfo.email), "Email da empresa (login) inválido."); break;
            case 'hospitalAddress': validate(isValidCEP(hospitalAddressInfo.cep), "CEP da empresa inválido."); validate(isNotEmpty(hospitalAddressInfo.street), "Rua da empresa é obrigatória."); validate(isNotEmpty(hospitalAddressInfo.number), "Número da empresa é obrigatório."); validate(isNotEmpty(hospitalAddressInfo.neighborhood), "Bairro da empresa é obrigatório."); validate(isNotEmpty(hospitalAddressInfo.city), "Cidade da empresa é obrigatória."); validate(isNotEmpty(hospitalAddressInfo.state) && hospitalAddressInfo.state.length === 2, "UF da empresa inválido."); break;
            case 'hospitalDocs': const hospitalDocKeys: HospitalDocKeys[] = ['socialContract', 'cnpjCard', 'companyAddressProof']; validate(!hospitalDocKeys.some(key => !isFilePresent(hospitalDocuments[key])), "Documentos da empresa (Contrato Social, Cartão CNPJ, Comprovante de Endereço) são obrigatórios."); break;
            case 'legalRepInfo': validate(isNotEmpty(legalRepresentativeInfo.name), "Nome do responsável é obrigatório."); validate(isValidDate(legalRepresentativeInfo.dob), "Data de nascimento do responsável inválida."); validate(isValidRG(legalRepresentativeInfo.rg), "RG do responsável inválido."); validate(isValidCPF(legalRepresentativeInfo.cpf), "CPF do responsável inválido."); validate(isValidPhone(legalRepresentativeInfo.phone), "Telefone do responsável inválido."); validate(isValidEmail(legalRepresentativeInfo.email), "Email pessoal do responsável inválido."); validate(isNotEmpty(legalRepresentativeInfo.position), "Cargo do responsável é obrigatório."); break;
            case 'legalRepDocs': const legalRepDocKeys: LegalRepDocKeys[] = ['repRg', 'repCpf', 'repAddressProof']; validate(!legalRepDocKeys.some(key => !isFilePresent(legalRepDocuments[key])), "Documentos do responsável (RG, CPF, Comprovante de Endereço) são obrigatórios."); break;
            case 'credentials': const loginEmail = role === 'doctor' ? personalInfo.email : hospitalInfo.email; if (!validate(isValidEmail(loginEmail), "O email de login (definido em etapas anteriores) parece inválido. Por favor, volte e corrija.")) { errorTitle = "Email de Login Inválido"; } else if (!validate(isValidPassword(credentials.password), "Sua senha deve ter no mínimo 6 caracteres.")) { errorTitle = "Senha Inválida"; } else if (!validate(credentials.password === credentials.confirmPassword, "As senhas não coincidem.")) { errorTitle = "Senhas Divergentes"; } break;
            default: console.warn("[RegisterPage] Tentando validar etapa desconhecida:", currentStepConfig?.id); break;
        }

        if (isValid) {
            if (step < totalSteps - 1) { console.log("[RegisterPage] Validation passed. Moving to next step."); setStep(s => s + 1); window.scrollTo(0, 0); }
            else { console.warn("[RegisterPage] Validation passed, but already at or beyond last step in handleNextStep. Step:", step, "TotalSteps-1:", totalSteps - 1); }
        } else {
            console.warn("[RegisterPage] Validation failed for step:", currentStepConfig?.id, "Error Title:", errorTitle, "Error Desc:", errorDescription);
            toast({ variant: "destructive", title: errorTitle, description: errorDescription });
        }
    }, [step, totalSteps, currentStepConfig, role, personalInfo, addressInfo, doctorDocuments, isSpecialist, specialistDocuments, hospitalInfo, hospitalAddressInfo, hospitalDocuments, legalRepresentativeInfo, legalRepDocuments, credentials, toast, isValidCPF, isValidCNPJ, isValidCEP, isValidDate, isValidEmail, isValidPassword, isValidPhone, isValidRG, isNotEmpty, isFilePresent]);

    const handlePrevStep = () => {
        console.log(`[RegisterPage] handlePrevStep called. Current step: ${step}`);
        if (step > 0) { if (step === 1 && role) { setRole(null); setStep(0); } else { setStep(s => s - 1); } window.scrollTo(0, 0); }
    };

    const handleSubmit = async () => {
        console.log("[RegisterPage] handleSubmit initiated. Current step ID:", currentStepConfig?.id, "Role:", role);
        if (!role || currentStepConfig?.id !== 'summary') { toast({ variant: "destructive", title: "Erro ao Finalizar", description: "Não é possível finalizar o cadastro nesta etapa ou sem um tipo de perfil selecionado." }); console.error("[RegisterPage] handleSubmit blocked. Role:", role, "Current step:", currentStepConfig?.id); return; }
        setIsLoading(true); setIsUploading(true); console.log("Iniciando registro final..."); const uploadedDocUrls = { doctorDocs: {} as Partial<DoctorDocumentsRef>, specialistDocs: {} as Partial<SpecialistDocumentsRef>, hospitalDocs: {} as Partial<HospitalDocumentsRef>, legalRepDocs: {} as Partial<LegalRepDocumentsRef>, }; try { const filesToUpload: { key: AllDocumentKeys; file: File }[] = []; if (role === 'doctor') { (Object.keys(doctorDocuments) as DoctorDocKeys[]).forEach(key => { if (doctorDocuments[key]) filesToUpload.push({ key, file: doctorDocuments[key]! }); }); if (isSpecialist) { (Object.keys(specialistDocuments) as SpecialistDocKeys[]).forEach(key => { if (specialistDocuments[key]) filesToUpload.push({ key, file: specialistDocuments[key]! }); }); } } else { (Object.keys(hospitalDocuments) as HospitalDocKeys[]).forEach(key => { if (hospitalDocuments[key]) filesToUpload.push({ key, file: hospitalDocuments[key]! }); }); (Object.keys(legalRepDocuments) as LegalRepDocKeys[]).forEach(key => { if (legalRepDocuments[key]) filesToUpload.push({ key, file: legalRepDocuments[key]! }); }); } console.log(`Iniciando upload de ${filesToUpload.length} arquivos...`); for (const item of filesToUpload) { await new Promise(resolve => setTimeout(resolve, 150)); const downloadURL = `https://fake-storage.com/${role}/${item.key}_${item.file.name}`; if (item.key in doctorDocuments) uploadedDocUrls.doctorDocs[item.key as DoctorDocKeys] = downloadURL; else if (item.key in specialistDocuments) uploadedDocUrls.specialistDocs[item.key as SpecialistDocKeys] = downloadURL; else if (item.key in hospitalDocuments) uploadedDocUrls.hospitalDocs[item.key as HospitalDocKeys] = downloadURL; else if (item.key in legalRepDocuments) uploadedDocUrls.legalRepDocs[item.key as LegalRepDocKeys] = downloadURL; } console.log("Uploads concluídos (ou simulados). URLs:", uploadedDocUrls); setIsUploading(false); const loginEmail = role === 'doctor' ? personalInfo.email : hospitalInfo.email; const displayName = role === 'doctor' ? personalInfo.name : hospitalInfo.companyName; let registrationPayload: DoctorRegistrationPayload | HospitalRegistrationPayload; if (role === 'doctor') { registrationPayload = { dob: personalInfo.dob, rg: personalInfo.rg, cpf: personalInfo.cpf, phone: personalInfo.phone, address: addressInfo, isSpecialist: isSpecialist, documents: uploadedDocUrls.doctorDocs as DoctorDocumentsRef, specialistDocuments: isSpecialist ? uploadedDocUrls.specialistDocs as SpecialistDocumentsRef : {}, }; } else { registrationPayload = { cnpj: hospitalInfo.cnpj, stateRegistration: hospitalInfo.stateRegistration, phone: hospitalInfo.phone, address: hospitalAddressInfo, legalRepresentativeInfo: { name: legalRepresentativeInfo.name, dob: legalRepresentativeInfo.dob, rg: legalRepresentativeInfo.rg, cpf: legalRepresentativeInfo.cpf, phone: legalRepresentativeInfo.phone, email: legalRepresentativeInfo.email, position: legalRepresentativeInfo.position, }, hospitalDocs: uploadedDocUrls.hospitalDocs as HospitalDocumentsRef, legalRepDocuments: uploadedDocUrls.legalRepDocs as LegalRepDocumentsRef, }; } console.log("Chamando registerUser com Payload:", JSON.stringify(registrationPayload, null, 2)); await registerUser( loginEmail, credentials.password, displayName, role, registrationPayload ); toast({ variant: "default", title: "Cadastro Realizado!", description: "Seu cadastro foi concluído com sucesso. Redirecionando para o painel...", }); if (role === 'doctor') { router.push('/dashboard/availability'); } else if (role === 'hospital') { router.push('/hospital/dashboard'); } else { console.warn("[RegisterPage] Role não definido no redirecionamento pós-cadastro, indo para Home."); router.push('/'); } } catch (error: any) { console.error("[RegisterPage] Erro ao finalizar cadastro:", error); setIsLoading(false); setIsUploading(false); let title = "Erro no Cadastro"; let description = "Ocorreu um erro inesperado ao tentar finalizar seu cadastro. Por favor, tente novamente."; if (isUploading && !(error instanceof FirebaseError)) { title = "Erro no Upload de Arquivos"; description = error.message || "Falha ao enviar um ou mais documentos. Verifique sua conexão e os arquivos."; } else if (error instanceof FirebaseError) { switch (error.code) { case 'auth/email-already-in-use': title = "Email já Cadastrado"; description="Este endereço de email já está em uso por outra conta."; break; case 'auth/invalid-email': title = "Formato de Email Inválido"; description="O email fornecido não é válido."; break; case 'auth/weak-password': title = "Senha Fraca"; description="Sua senha é muito fraca. Por favor, use uma senha com no mínimo 6 caracteres.";break; default: description = error.message || description; } } else if (error instanceof Error) { description = error.message; } toast({ variant: "destructive", title: title, description: description }); }
    };

    // --- CORRIGIDO: renderCurrentStep com todos os cases ---
    const renderCurrentStep = () => {
        console.log(`[RegisterPage] renderCurrentStep called. Current step config ID: ${currentStepConfig?.id}`);
        if (!currentStepConfig) { console.error("[RegisterPage] No currentStepConfig in renderCurrentStep. Step index:", step); return <div className="p-4 text-center text-red-500">Erro: Etapa de cadastro inválida ou não carregada. Por favor, atualize a página.</div>; }

        switch (currentStepConfig.id) {
            case 'role':
                return ( <div className="space-y-4 animate-fade-in"> <Label className="text-base font-semibold block text-center mb-6">Selecione o tipo de cadastro:</Label> <RadioGroup value={role ?? ""} onValueChange={(value) => { console.log("[RegisterPage] Role selected:", value); setRole(value as UserType); setStep(s => s + 1); }} className="grid grid-cols-1 md:grid-cols-2 gap-4"> <Label htmlFor="role-doctor" className={cn( "flex flex-col items-center justify-center p-6 border rounded-lg cursor-pointer transition-colors", "hover:bg-blue-50 hover:border-blue-400", role === 'doctor' ? "bg-blue-50 border-blue-500 ring-2 ring-blue-500" : "bg-white border-gray-300" )} > <RadioGroupItem value="doctor" id="role-doctor" className="sr-only" /> <Stethoscope className={cn("h-10 w-10 mb-3", role === 'doctor' ? "text-blue-700" : "text-gray-500")} /> <span className={cn("font-medium", role === 'doctor' ? "text-blue-800" : "text-gray-700")}>Sou Médico(a) / Profissional</span> </Label> <Label htmlFor="role-hospital" className={cn( "flex flex-col items-center justify-center p-6 border rounded-lg cursor-pointer transition-colors", "hover:bg-blue-50 hover:border-blue-400", role === 'hospital' ? "bg-blue-50 border-blue-500 ring-2 ring-blue-500" : "bg-white border-gray-300" )} > <RadioGroupItem value="hospital" id="role-hospital" className="sr-only" /> <Building className={cn("h-10 w-10 mb-3", role === 'hospital' ? "text-blue-700" : "text-gray-500")} /> <span className={cn("font-medium", role === 'hospital' ? "text-blue-800" : "text-gray-700")}>Sou Empresa / Hospital</span> </Label> </RadioGroup> {!role && step === 0 && <p className="text-sm text-red-600 pt-4 text-center">Por favor, selecione uma opção para iniciar seu cadastro.</p>} </div> );
            case 'personalInfo':
                return ( <form autoComplete="off" onSubmit={(e) => {e.preventDefault(); handleNextStep();}} className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Dados Pessoais</h3> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"> <div className="space-y-1"><Label htmlFor="name">Nome Completo*</Label><Input id="name" name="name" autoComplete="name" value={personalInfo.name} onChange={(e) => handleInputChange(e, setPersonalInfo, 'name')} required /></div> <div className="space-y-1"><Label htmlFor="dob">Nascimento*</Label><Input id="dob" name="bday" autoComplete="bday" type="date" value={personalInfo.dob} onChange={(e) => handleInputChange(e, setPersonalInfo, 'dob')} required max={new Date().toISOString().split("T")[0]}/></div> <div className="space-y-1"><Label htmlFor="rg">RG*</Label><Input id="rg" name="rg" autoComplete="off" value={personalInfo.rg} onChange={(e) => handleInputChange(e, setPersonalInfo, 'rg')} required /></div> <div className="space-y-1"> <Label htmlFor="cpf">CPF*</Label> <InputWithIMask id="cpf" name="cpf" autoComplete="off" maskOptions={{ mask: '000.000.000-00' }} defaultValue={personalInfo.cpf} onAccept={(v) => handleIMaskAccept(v, {} as any, setPersonalInfo, 'cpf')} required placeholder="000.000.000-00" /> </div> <div className="space-y-1"> <Label htmlFor="phone">Telefone Celular*</Label> <InputWithIMask id="phone" name="tel" autoComplete="tel" maskOptions={{ mask: [{ mask: '(00) 0000-0000' }, { mask: '(00) 00000-0000' }] }} defaultValue={personalInfo.phone} onAccept={(v) => handleIMaskAccept(v, {} as any, setPersonalInfo, 'phone')} required placeholder="(00) 90000-0000" type="tel" /> </div> <div className="space-y-1"><Label htmlFor="email">Email (Login)*</Label><Input id="email" name="email" type="email" autoComplete="email" value={personalInfo.email} onChange={(e) => handleInputChange(e, setPersonalInfo, 'email')} required /></div> </div> </form>);
            case 'addressInfo':
                return ( <form autoComplete="off" onSubmit={(e) => {e.preventDefault(); handleNextStep();}} className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Endereço Pessoal</h3> <div className="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4"> <div className="space-y-1 md:col-span-1"><Label htmlFor="cep">CEP*</Label><InputWithIMask id="cep" name="postal-code" autoComplete="postal-code" maskOptions={{ mask: '00000-000' }} defaultValue={addressInfo.cep} onAccept={(v) => handleIMaskAccept(v, {} as any, setAddressInfo, 'cep')} required placeholder="00000-000"/></div> <div className="space-y-1 md:col-span-2"><Label htmlFor="street">Rua/Avenida*</Label><Input id="street" name="street-address" autoComplete="street-address" value={addressInfo.street} onChange={(e) => handleInputChange(e, setAddressInfo, 'street')} required /></div> <div className="space-y-1"><Label htmlFor="number">Número*</Label><Input id="number" name="address-line2" autoComplete="address-line2" value={addressInfo.number} onChange={(e) => handleInputChange(e, setAddressInfo, 'number')} required /></div> <div className="space-y-1"><Label htmlFor="complement">Complemento</Label><Input id="complement" name="address-line3" autoComplete="address-line3" value={addressInfo.complement ?? ""} onChange={(e) => handleInputChange(e, setAddressInfo, 'complement')} /></div> <div className="space-y-1"><Label htmlFor="neighborhood">Bairro*</Label><Input id="neighborhood" name="address-level3" autoComplete="off" value={addressInfo.neighborhood} onChange={(e) => handleInputChange(e, setAddressInfo, 'neighborhood')} required /></div> <div className="space-y-1"><Label htmlFor="city">Cidade*</Label><Input id="city" name="address-level2" autoComplete="address-level2" value={addressInfo.city} onChange={(e) => handleInputChange(e, setAddressInfo, 'city')} required /></div> <div className="space-y-1"><Label htmlFor="state">Estado (UF)*</Label><Input id="state" name="address-level1" autoComplete="address-level1" value={addressInfo.state} onChange={(e) => handleInputChange(e, setAddressInfo, 'state')} maxLength={2} required placeholder="SP"/></div> </div> </form>);
            case 'essentialDocs':
                return ( <div className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Documentos Essenciais</h3> <p className="text-xs text-gray-500 mb-3">Formatos aceitos: PDF, JPG, PNG. Tamanho máximo por arquivo: 5MB.</p> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">{['personalRg', 'personalCpf', 'professionalCrm', 'photo3x4', 'addressProof', 'graduationCertificate'].map(key => renderFileInput(key as DoctorDocKeys))}</div> </div>);
            case 'certsAndCvDocs':
                return ( <div className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Certidões e Currículo</h3> <p className="text-xs text-gray-500 mb-3">Formatos aceitos: PDF, JPG, PNG. Tamanho máximo por arquivo: 5MB.</p> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">{['criminalRecordCert', 'ethicalCert', 'debtCert', 'cv'].map(key => renderFileInput(key as DoctorDocKeys))}</div> </div>);
            case 'isSpecialist':
                return ( <div className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Especialidade Médica</h3> <div className="flex items-center space-x-3 p-4 border rounded-md bg-blue-50 border-blue-200 shadow-sm"> <Switch id="is-specialist-switch" checked={isSpecialist} onCheckedChange={setIsSpecialist} /> <Label htmlFor="is-specialist-switch" className="font-medium text-gray-700 cursor-pointer">Possui Registro de Qualificação de Especialista (RQE)?</Label> </div> {isSpecialist ? <p className="text-sm text-blue-700 mt-2 flex items-start gap-1.5"><Info size={16} className="shrink-0 relative top-0.5"/><span>Ótimo! Na próxima etapa, você precisará enviar os documentos comprobatórios da sua especialidade.</span></p> : <p className="text-sm text-gray-600 mt-2">Ok, você pode prosseguir para a definição da sua senha de acesso.</p>} </div>);
            case 'specialistDocs':
                return ( <div className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Documentos de Especialista</h3> <p className="text-xs text-gray-500 mb-3">Envie os comprovantes da sua especialidade (RQE, Certificado de Pós-Graduação, Título de Especialista).</p> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">{['rqe', 'postGradCert', 'specialistTitle', 'recommendationLetter'].map(key => renderFileInput(key as SpecialistDocKeys))}</div> </div>);
            case 'hospitalInfo':
                return ( <form autoComplete="off" onSubmit={(e) => {e.preventDefault(); handleNextStep();}} className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Dados da Empresa</h3> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"> <div className="space-y-1 md:col-span-2"><Label htmlFor="companyName">Razão Social*</Label><Input id="companyName" name="organization" autoComplete="organization" value={hospitalInfo.companyName} onChange={(e) => handleInputChange(e, setHospitalInfo, 'companyName')} required /></div> <div className="space-y-1"><Label htmlFor="cnpj">CNPJ*</Label><InputWithIMask id="cnpj" name="cnpj" autoComplete="off" maskOptions={{ mask: '00.000.000/0000-00' }} defaultValue={hospitalInfo.cnpj} onAccept={(v) => handleIMaskAccept(v, {} as any, setHospitalInfo, 'cnpj')} required placeholder="00.000.000/0000-00"/></div> <div className="space-y-1"><Label htmlFor="stateRegistration">Inscrição Estadual</Label><Input id="stateRegistration" name="stateRegistration" autoComplete="off" value={hospitalInfo.stateRegistration ?? ""} onChange={(e) => handleInputChange(e, setHospitalInfo, 'stateRegistration')} /><p className="text-xs text-gray-500">Deixe em branco se isento ou não aplicável.</p></div> <div className="space-y-1"><Label htmlFor="hospitalPhone">Telefone Comercial*</Label><InputWithIMask id="hospitalPhone" name="tel" autoComplete="tel-national" maskOptions={{ mask: [{ mask: '(00) 0000-0000' }, { mask: '(00) 00000-0000' }] }} defaultValue={hospitalInfo.phone} onAccept={(v) => handleIMaskAccept(v, {} as any, setHospitalInfo, 'phone')} required placeholder="(00) 0000-0000" type="tel"/></div> <div className="space-y-1"><Label htmlFor="hospitalEmail">Email da Empresa (Login)*</Label><Input id="hospitalEmail" name="email" type="email" autoComplete="email" value={hospitalInfo.email} onChange={(e) => handleInputChange(e, setHospitalInfo, 'email')} required /></div> </div> </form>);
            case 'hospitalAddress':
                return ( <form autoComplete="off" onSubmit={(e) => {e.preventDefault(); handleNextStep();}} className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Endereço da Empresa</h3> <div className="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4"> <div className="space-y-1 md:col-span-1"><Label htmlFor="hosp-cep">CEP*</Label><InputWithIMask id="hosp-cep" name="postal-code" autoComplete="postal-code" maskOptions={{ mask: '00000-000' }} defaultValue={hospitalAddressInfo.cep} onAccept={(v) => handleIMaskAccept(v, {} as any, setHospitalAddressInfo, 'cep')} required placeholder="00000-000"/></div> <div className="space-y-1 md:col-span-2"><Label htmlFor="hosp-street">Rua/Avenida*</Label><Input id="hosp-street" name="street-address" autoComplete="street-address" value={hospitalAddressInfo.street} onChange={(e) => handleInputChange(e, setHospitalAddressInfo, 'street')} required /></div> <div className="space-y-1"><Label htmlFor="hosp-number">Número*</Label><Input id="hosp-number" name="address-line2" autoComplete="address-line2" value={hospitalAddressInfo.number} onChange={(e) => handleInputChange(e, setHospitalAddressInfo, 'number')} required /></div> <div className="space-y-1"><Label htmlFor="hosp-complement">Complemento</Label><Input id="hosp-complement" name="address-line3" autoComplete="address-line3" value={hospitalAddressInfo.complement ?? ""} onChange={(e) => handleInputChange(e, setHospitalAddressInfo, 'complement')} /></div> <div className="space-y-1"><Label htmlFor="hosp-neighborhood">Bairro*</Label><Input id="hosp-neighborhood" name="address-level3" autoComplete="off" value={hospitalAddressInfo.neighborhood} onChange={(e) => handleInputChange(e, setHospitalAddressInfo, 'neighborhood')} required /></div> <div className="space-y-1"><Label htmlFor="hosp-city">Cidade*</Label><Input id="hosp-city" name="address-level2" autoComplete="address-level2" value={hospitalAddressInfo.city} onChange={(e) => handleInputChange(e, setHospitalAddressInfo, 'city')} required /></div> <div className="space-y-1"><Label htmlFor="hosp-state">Estado (UF)*</Label><Input id="hosp-state" name="address-level1" autoComplete="address-level1" value={hospitalAddressInfo.state} onChange={(e) => handleInputChange(e, setHospitalAddressInfo, 'state')} maxLength={2} required placeholder="SP"/></div> </div> </form>);
            case 'hospitalDocs':
                return ( <div className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Documentos da Empresa</h3> <p className="text-xs text-gray-500 mb-3">Formatos: PDF, JPG, PNG. Máx: 5MB.</p> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">{['socialContract', 'cnpjCard', 'companyAddressProof'].map(key => renderFileInput(key as HospitalDocKeys))}</div> </div>);
            case 'legalRepInfo':
                return ( <form autoComplete="off" onSubmit={(e) => {e.preventDefault(); handleNextStep();}} className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Dados do Responsável Legal</h3> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"> <div className="space-y-1"><Label htmlFor="repName">Nome Completo do Responsável*</Label><Input id="repName" name="name" autoComplete="name" value={legalRepresentativeInfo.name} onChange={(e) => handleInputChange(e, setLegalRepresentativeInfo, 'name')} required /></div> <div className="space-y-1"><Label htmlFor="repDob">Nascimento do Responsável*</Label><Input id="repDob" name="bday" autoComplete="bday" type="date" value={legalRepresentativeInfo.dob} onChange={(e) => handleInputChange(e, setLegalRepresentativeInfo, 'dob')} required max={new Date().toISOString().split("T")[0]}/></div> <div className="space-y-1"><Label htmlFor="repRg">RG do Responsável*</Label><Input id="repRg" name="rg" autoComplete="off" value={legalRepresentativeInfo.rg} onChange={(e) => handleInputChange(e, setLegalRepresentativeInfo, 'rg')} required /></div> <div className="space-y-1"><Label htmlFor="repCpf">CPF do Responsável*</Label><InputWithIMask id="repCpf" name="cpf" autoComplete="off" maskOptions={{ mask: '000.000.000-00' }} defaultValue={legalRepresentativeInfo.cpf} onAccept={(v) => handleIMaskAccept(v, {} as any, setLegalRepresentativeInfo, 'cpf')} required placeholder="000.000.000-00"/></div> <div className="space-y-1"><Label htmlFor="repPhone">Telefone do Responsável*</Label><InputWithIMask id="repPhone" name="tel" autoComplete="tel" maskOptions={{ mask: [{ mask: '(00) 0000-0000' }, { mask: '(00) 00000-0000' }] }} defaultValue={legalRepresentativeInfo.phone} onAccept={(v) => handleIMaskAccept(v, {} as any, setLegalRepresentativeInfo, 'phone')} required placeholder="(00) 90000-0000" type="tel"/></div> <div className="space-y-1"><Label htmlFor="repEmail">Email Pessoal do Responsável*</Label><Input id="repEmail" name="email" type="email" autoComplete="email" value={legalRepresentativeInfo.email} onChange={(e) => handleInputChange(e, setLegalRepresentativeInfo, 'email')} required /></div> <div className="space-y-1 md:col-span-2"><Label htmlFor="repPosition">Cargo do Responsável na Empresa*</Label><Input id="repPosition" name="organization-title" autoComplete="organization-title" value={legalRepresentativeInfo.position} onChange={(e) => handleInputChange(e, setLegalRepresentativeInfo, 'position')} required /></div> </div> </form>);
            case 'legalRepDocs':
                return ( <div className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Documentos do Responsável Legal</h3> <p className="text-xs text-gray-500 mb-3">Formatos: PDF, JPG, PNG. Máx: 5MB.</p> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">{['repRg', 'repCpf', 'repAddressProof'].map(key => renderFileInput(key as LegalRepDocKeys))}</div> </div>);
            case 'credentials':
                const loginEmail = role === 'doctor' ? personalInfo.email : hospitalInfo.email;
                const emailIsCurrentlyValid = isValidEmail(loginEmail);
                return ( <form autoComplete="off" onSubmit={(e) => {e.preventDefault(); handleNextStep();}} className="space-y-4 animate-fade-in"> <h3 className="text-lg font-semibold border-b pb-2 mb-4">Crie sua Senha de Acesso</h3> <div className={cn("p-3 rounded-md text-sm mb-4", emailIsCurrentlyValid ? "bg-blue-50 border border-blue-200 text-blue-700" : "bg-red-50 border border-red-200 text-red-700")}> Email para login: <strong className={cn("break-all", !emailIsCurrentlyValid && "font-semibold")}>{loginEmail || "(Email não definido ou inválido nas etapas anteriores)"}</strong> {!emailIsCurrentlyValid && loginEmail && <span className="ml-2 font-medium">(Inválido!)</span>} {!emailIsCurrentlyValid && <p className="text-xs mt-1">Por favor, volte às etapas anteriores para corrigir o email de login.</p>} </div> <div className="space-y-1"><Label htmlFor="password">Senha*</Label><Input id="password" name="new-password" type="password" autoComplete="new-password" value={credentials.password} onChange={(e) => handleInputChange(e, setCredentials, 'password')} required minLength={6} /> <p className="text-xs text-gray-500">Use no mínimo 6 caracteres. Combine letras, números e símbolos para maior segurança.</p></div> <div className="space-y-1"><Label htmlFor="confirmPassword">Confirme a Senha*</Label><Input id="confirmPassword" name="new-password" type="password" autoComplete="new-password" value={credentials.confirmPassword} onChange={(e) => handleInputChange(e, setCredentials, 'confirmPassword')} required className={cn( credentials.password && credentials.confirmPassword && credentials.password !== credentials.confirmPassword && "border-red-500 ring-1 ring-red-500" )} /> {credentials.password && credentials.confirmPassword && credentials.password !== credentials.confirmPassword && <p className="text-xs text-red-600 mt-1">As senhas não coincidem.</p>}</div> </form>);
            case 'summary':
                console.log("[RegisterPage] Rendering SUMMARY case. Role:", role);
                if (!role) { console.error("[RegisterPage] SUMMARY case: Role is null. Cannot render summary."); return <div className="p-4 text-center text-red-500">Erro: Tipo de perfil não definido para a revisão.</div>; }
                const summaryDataToRender: SummaryData = role === 'doctor' ?
                    { personalInfo, addressInfo, doctorDocuments, isSpecialist, specialistDocuments, credentials } :
                    { hospitalInfo, hospitalAddressInfo, hospitalDocuments, legalRepresentativeInfo, legalRepDocuments, credentials };
                console.log("[RegisterPage] SUMMARY case: Data for RegistrationSummary:", JSON.stringify(summaryDataToRender, null, 2));
                return <RegistrationSummary role={role} data={summaryDataToRender} onEdit={handleEditStep} />;
            default:
                console.warn("[RegisterPage] Unknown step ID in renderCurrentStep:", currentStepConfig.id);
                return <p>Etapa desconhecida ({currentStepConfig.id}). Por favor, tente voltar.</p>; // Adicionado o ID da etapa desconhecida
        }
    };

    return (
        <div className="container mx-auto px-4 py-8 sm:py-12 max-w-4xl">
             <h1 className="text-2xl sm:text-3xl font-bold text-center mb-3 text-gray-800">Formulário de Cadastro</h1>
             <p className="text-center text-gray-600 text-sm sm:text-base mb-8 sm:mb-10"> Siga as etapas para completar seu registro. Já tem conta?{" "} <Link href="/login" className="text-blue-600 hover:underline font-medium">Faça login</Link> </p>
             <StepIndicator steps={stepsConfig.map(s => s.label)} currentStep={currentStepIndex} />
             <div className="bg-white p-4 sm:p-6 md:p-8 rounded-lg shadow-xl border border-gray-200 min-h-[350px] relative">
                 {(isLoading || isUploading) && ( <div className="absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-20 rounded-lg"> <Loader2 className="h-10 w-10 sm:h-12 sm:w-12 animate-spin text-blue-600" /> <p className="mt-4 text-base sm:text-lg font-medium text-gray-700">{isUploading ? 'Enviando documentos...' : (isLoading ? 'Processando cadastro...' : '')}</p> <p className="mt-1 text-sm text-gray-500">Por favor, aguarde um momento...</p> </div> )}
                 <div className={cn("transition-opacity duration-300", (isLoading || isUploading) && "opacity-20 pointer-events-none")}> {renderCurrentStep()} </div>
             </div>
             <div className="flex flex-col sm:flex-row justify-between mt-8 sm:mt-10 gap-3 sm:gap-4">
                 <Button variant="outline" onClick={handlePrevStep} disabled={step === 0 || isLoading || isUploading} className="w-full sm:w-auto px-6 py-3 text-sm sm:text-base" > Voltar </Button>
                 {currentStepConfig?.id === 'summary' ? (
                     <Button onClick={handleSubmit} disabled={isLoading || isUploading || !role} className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-3 text-sm sm:text-base" > {isLoading ? <Loader2 className="mr-2 h-5 w-5 animate-spin" /> : <Check className="mr-2 h-5 w-5" />} {isLoading ? (isUploading ? 'Enviando...' : 'Finalizando...') : 'Confirmar e Finalizar Cadastro'} </Button>
                 ) : (
                     <Button onClick={handleNextStep} disabled={(!role && step === 0 && currentStepConfig?.id === 'role') || isLoading || isUploading} className="w-full sm:w-auto px-6 py-3 text-sm sm:text-base bg-blue-600 hover:bg-blue-700 text-white" > Próximo </Button>
                 )}
             </div>
        </div>
    );
}