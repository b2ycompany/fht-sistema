(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[267],{12326:function(e,t,a){Promise.resolve().then(a.bind(a,28451))},28451:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return _}});var s=a(57437),r=a(2265),o=a(99376),i=a(62869),n=a(66070),c=a(26110),l=a(35153),d=a(51817),m=a(43044),u=a(76865),h=a(69076),x=a(53581),p=a(58896),f=a(83774),g=a(88501),v=a(91723),N=a(92369),j=a(29090),b=a(47692),y=a(29374),w=a(5978),k=a(17293);let C=async()=>{let e=k.I8.currentUser;if(!e)throw Error("Utilizador n\xe3o autenticado.");let t=(0,w.hJ)(k.db,"contracts"),a=(0,w.IO)(t,(0,w.ar)("doctorId","==",e.uid),(0,w.ar)("status","in",["ACTIVE_SIGNED","IN_PROGRESS"])),s=await (0,w.PL)(a);if(s.empty)return[];let r=s.docs.map(async e=>{let t=e.data(),a="SCHEDULED";"IN_PROGRESS"===t.status&&(a="CHECKED_IN");let s={id:e.id,contractId:e.id,serviceType:t.serviceType,hospitalName:t.hospitalName,locationCity:t.locationCity,locationState:t.locationState,shiftDate:t.shiftDates[0],expectedStartTime:t.startTime,expectedEndTime:t.endTime,status:a,checkinAt:t.checkinAt,checkoutAt:t.checkoutAt,checkinLocation:t.checkinLocation,checkoutLocation:t.checkoutLocation};if("Telemedicina"===t.serviceType){let t=(0,w.IO)((0,w.hJ)(k.db,"consultations"),(0,w.ar)("contractId","==",e.id),(0,w.b9)(1)),a=await (0,w.PL)(t);if(!a.empty){let e=a.docs[0].data();s.patientName=e.patientName,s.chiefComplaint=e.chiefComplaint}}return s});return(await Promise.all(r)).sort((e,t)=>e.shiftDate.toMillis()-t.shiftDate.toMillis())},E=async(e,t,a,s)=>{if(!s)throw Error("A foto de verifica\xe7\xe3o \xe9 obrigat\xf3ria para o check-in.");let r=(0,w.JU)(k.db,"contracts",e);await (0,w.r7)(r,{checkinAt:(0,w.Bt)(),checkinLocation:{latitude:t,longitude:a},checkinPhotoUrl:s,status:"IN_PROGRESS",updatedAt:(0,w.Bt)()})},z=async(e,t,a)=>{let s=(0,w.JU)(k.db,"contracts",e);await (0,w.r7)(s,{checkoutAt:(0,w.Bt)(),checkoutLocation:{latitude:t,longitude:a},status:"COMPLETED",updatedAt:(0,w.Bt)()})};var S=a(87598),D=a(15822),A=a(94508),I=a(35974);let P=r.memo(e=>{let{message:t="A carregar os seus plant\xf5es..."}=e;return(0,s.jsxs)("div",{className:"flex flex-col justify-center items-center text-center py-10 min-h-[150px] w-full",children:[(0,s.jsx)(d.Z,{className:"h-8 w-8 animate-spin text-blue-600"}),(0,s.jsx)("p",{className:"mt-3 text-sm text-gray-600",children:t})]})}),L=r.memo(e=>{let{message:t}=e;return(0,s.jsxs)("div",{className:"text-center text-sm text-gray-500 py-10 min-h-[150px] flex flex-col items-center justify-center bg-gray-50/70 rounded-md border border-dashed border-gray-300 w-full",children:[(0,s.jsx)(m.Z,{className:"w-12 h-12 text-gray-400 mb-4"}),(0,s.jsx)("p",{className:"font-medium text-gray-600 mb-1",children:"Nenhum plant\xe3o encontrado"}),(0,s.jsx)("p",{className:"max-w-xs",children:t})]})}),Z=r.memo(e=>{let{message:t,onRetry:a}=e;return(0,s.jsxs)("div",{className:"text-center text-sm text-red-600 py-10 min-h-[150px] flex flex-col items-center justify-center bg-red-50/70 rounded-md border border-dashed border-red-300 w-full",children:[(0,s.jsx)(u.Z,{className:"w-12 h-12 text-red-400 mb-4"}),(0,s.jsx)("p",{className:"font-semibold text-red-700 mb-1 text-base",children:"Oops! Algo deu errado."}),(0,s.jsx)("p",{className:"max-w-md text-red-600",children:t||"N\xe3o foi poss\xedvel carregar os dados."}),a&&(0,s.jsxs)(i.z,{variant:"destructive",size:"sm",onClick:a,className:"mt-4",children:[(0,s.jsx)(h.Z,{className:"mr-2 h-4 w-4"})," Tentar Novamente"]})]})}),O=(e,t)=>{var a;let s=e.split(","),r=null===(a=s[0].match(/:(.*?);/))||void 0===a?void 0:a[1],o=atob(s[1]),i=o.length,n=new Uint8Array(i);for(;i--;)n[i]=o.charCodeAt(i);return new File([n],t,{type:r})},R=e=>{let{isOpen:t,onClose:a,onCapture:o}=e,n=(0,r.useRef)(null),l=(0,r.useRef)(null),[m,u]=(0,r.useState)(!1),[h,p]=(0,r.useState)(null);return(0,r.useEffect)(()=>{if(!t)return;p(null),u(!1);let e=null;return(async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw Error("O seu navegador n\xe3o suporta acesso \xe0 c\xe2mera.");e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}),n.current&&(n.current.srcObject=e,n.current.onloadedmetadata=()=>{u(!0)})}catch(e){console.error("Erro ao aceder \xe0 c\xe2mera:",e),e instanceof DOMException&&"NotAllowedError"===e.name?p("Permiss\xe3o para aceder \xe0 c\xe2mera foi negada. Por favor, habilite-a nas configura\xe7\xf5es do seu navegador."):p("N\xe3o foi poss\xedvel aceder \xe0 c\xe2mera.")}})(),()=>{e&&e.getTracks().forEach(e=>e.stop()),n.current&&(n.current.srcObject=null),u(!1)}},[t]),(0,s.jsx)(c.Vq,{open:t,onOpenChange:a,children:(0,s.jsxs)(c.cZ,{children:[(0,s.jsxs)(c.fK,{children:[(0,s.jsx)(c.$N,{children:"Verifica\xe7\xe3o por Foto"}),(0,s.jsx)(c.Be,{children:"Centralize o seu rosto e capture a imagem para o check-in."})]}),(0,s.jsxs)("div",{className:"relative aspect-video w-full overflow-hidden rounded-md bg-gray-900 flex items-center justify-center",children:[h&&(0,s.jsx)("div",{className:"p-4 text-center text-sm text-red-100",children:h}),(0,s.jsx)("video",{ref:n,autoPlay:!0,playsInline:!0,className:(0,A.cn)("h-full w-full object-cover",{hidden:h})}),!m&&!h&&(0,s.jsx)(d.Z,{className:"h-8 w-8 animate-spin text-white absolute"}),(0,s.jsx)("canvas",{ref:l,className:"hidden"})]}),(0,s.jsxs)(i.z,{onClick:()=>{if(n.current&&l.current&&m){var e;let t=n.current,s=l.current;s.width=t.videoWidth,s.height=t.videoHeight,null===(e=s.getContext("2d"))||void 0===e||e.drawImage(t,0,0,t.videoWidth,t.videoHeight),o(s.toDataURL("image/jpeg",.9)),a()}},disabled:!m||!!h,children:[(0,s.jsx)(x.Z,{className:"mr-2 h-4 w-4"})," Capturar Foto"]})]})})},T=e=>{let{location:t}=e,[a,o]=(0,r.useState)("A obter nome do local...");return(0,r.useEffect)(()=>{t&&(async()=>{try{var e,a,s,r;let{latitude:i,longitude:n}=t,c=await fetch("https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=".concat(i,"&lon=").concat(n));if(!c.ok)throw Error("Falha na resposta da API de geolocaliza\xe7\xe3o");let l=await c.json(),d=(null===(e=l.address)||void 0===e?void 0:e.city)||(null===(a=l.address)||void 0===a?void 0:a.town)||(null===(s=l.address)||void 0===s?void 0:s.village),m=null===(r=l.address)||void 0===r?void 0:r.state;o(d&&m?"".concat(d,", ").concat(m):"Nome do local n\xe3o encontrado")}catch(e){console.error("Erro no reverse geocoding:",e),o("N\xe3o foi poss\xedvel obter o nome do local")}})()},[t]),(0,s.jsxs)("div",{className:"text-xs text-gray-500 flex items-center",children:[(0,s.jsx)(p.Z,{size:13,className:"mr-1.5"}),"Local registado: ",a]})};function _(){let{toast:e}=(0,l.pm)(),t=(0,o.useRouter)(),[a,i]=(0,r.useState)([]),[c,d]=(0,r.useState)(!0),[m,h]=(0,r.useState)(null),[x,p]=(0,r.useState)(null),[f,g]=(0,r.useState)(!1),[v,N]=(0,r.useState)(null),j=(0,r.useCallback)(async()=>{d(!0),h(null);try{let e=await C();i(e)}catch(e){h(e.message||"Falha ao carregar plant\xf5es.")}finally{d(!1)}},[]);(0,r.useEffect)(()=>{j()},[j]);let b=async a=>{p(a),e({title:"Preparando a sala de atendimento...",description:"Aguarde um momento."});try{await (0,S.yj)(a),t.push("/telemedicine/".concat(a))}catch(t){e({title:"Erro ao Iniciar Atendimento",description:t.message,variant:"destructive"})}finally{p(null)}},y=async t=>{p(t),navigator.geolocation.getCurrentPosition(async a=>{try{await z(t,a.coords.latitude,a.coords.longitude),e({title:"Check-out Realizado!",description:"O seu fim de plant\xe3o foi registado.",variant:"success"}),j()}catch(t){e({title:"Erro ao fazer Check-out",description:t.message,variant:"destructive"})}finally{p(null)}},t=>{e({title:"Falha na Geolocaliza\xe7\xe3o",description:"N\xe3o foi poss\xedvel obter sua localiza\xe7\xe3o para o checkout.",variant:"destructive"}),p(null)})},w=e=>{N(e),g(!0)};return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)(R,{isOpen:f,onClose:()=>g(!1),onCapture:t=>{if(!v||!k.I8.currentUser)return;let a=k.I8.currentUser.uid;p(v),e({title:"A obter a sua localiza\xe7\xe3o..."}),navigator.geolocation.getCurrentPosition(async s=>{let{latitude:r,longitude:o}=s.coords;try{e({title:"A enviar a sua foto..."});let s=O(t,"".concat(v,".jpg")),i="checkin_photos/".concat(a,"/").concat(v,".jpg"),n=await (0,D.v)(s,i);e({title:"A registar o seu check-in..."}),await E(v,r,o,n),e({title:"Check-in Realizado!",description:"O seu in\xedcio de plant\xe3o foi registado com sucesso.",variant:"success"}),j()}catch(t){e({title:"Erro no Processo de Check-in",description:t.message,variant:"destructive"})}finally{p(null)}},t=>{let a="N\xe3o foi poss\xedvel obter a sua localiza\xe7\xe3o. ";t.code===t.PERMISSION_DENIED?a+="Por favor, ative a permiss\xe3o de localiza\xe7\xe3o no seu navegador.":a+="Ocorreu um erro desconhecido.",e({title:"Falha na Geolocaliza\xe7\xe3o",description:a,variant:"destructive"}),p(null)},{timeout:15e3,enableHighAccuracy:!0})}}),(0,s.jsx)("h1",{className:"text-2xl md:text-3xl font-bold",children:"Check-in / Check-out de Plant\xf5es"}),(0,s.jsxs)(n.Zb,{children:[(0,s.jsxs)(n.Ol,{children:[(0,s.jsx)(n.ll,{children:"Seus Pr\xf3ximos Plant\xf5es"}),(0,s.jsx)(n.SZ,{children:"Realize o check-in ao iniciar e o check-out ao finalizar seus plant\xf5es aqui."})]}),(0,s.jsxs)(n.aY,{children:[c&&(0,s.jsx)(P,{}),!c&&m&&(0,s.jsx)(Z,{message:m,onRetry:j}),!c&&!m&&0===a.length&&(0,s.jsx)(L,{message:"Voc\xea n\xe3o tem plant\xf5es confirmados que requerem check-in/out."}),!c&&!m&&a.length>0&&(0,s.jsx)("div",{className:"space-y-4",children:a.map(e=>(0,s.jsx)(U,{record:e,onCheckinClick:()=>w(e.id),onCheckoutClick:y,onStartTelemedicineClick:b,isActionLoading:x},e.id))})]})]}),(0,s.jsx)("div",{className:"mt-6 p-4 border rounded-lg bg-amber-50 text-amber-800",children:(0,s.jsxs)("div",{className:"flex items-start",children:[(0,s.jsx)(u.Z,{className:"h-5 w-5 mr-3 mt-0.5 text-amber-600"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Importante sobre Geolocaliza\xe7\xe3o e C\xe2mera"}),(0,s.jsx)("p",{className:"text-xs mt-1",children:"Para realizar o check-in, o seu navegador solicitar\xe1 permiss\xe3o para aceder \xe0 sua localiza\xe7\xe3o e c\xe2mera. Isto \xe9 necess\xe1rio para validar a sua presen\xe7a e identidade no local do plant\xe3o."})]})]})})]})}let U=e=>{let{record:t,onCheckinClick:a,onCheckoutClick:r,onStartTelemedicineClick:o,isActionLoading:c}=e,l=t.shiftDate.toDate(),m=c===t.id||c===t.contractId,u="Telemedicina"===t.serviceType,h=u&&("SCHEDULED"===t.status||"CHECKED_IN"===t.status),x=!u&&"SCHEDULED"===t.status,p=!u&&"CHECKED_IN"===t.status,w="CHECKED_OUT"===t.status,k=(e=>{switch(e){case"SCHEDULED":return{variant:"outline",className:"border-blue-300 text-blue-700 bg-blue-50"};case"CHECKED_IN":return{variant:"default",className:"bg-green-100 text-green-800 border-green-300"};case"CHECKED_OUT":return{variant:"secondary",className:"bg-gray-200 text-gray-700"};default:return{variant:"destructive",className:""}}})(t.status);return(0,s.jsxs)(n.Zb,{className:(0,A.cn)("shadow-sm transition-all","CHECKED_IN"===t.status&&"border-green-500 ring-2 ring-green-500/50"),children:[(0,s.jsxs)(n.Ol,{children:[(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsx)(n.ll,{className:"text-md mb-1",children:t.hospitalName}),(0,s.jsx)(I.C,{variant:k.variant,className:(0,A.cn)("capitalize",k.className),children:t.status.replace(/_/g," ").toLowerCase()})]}),(0,s.jsxs)(n.SZ,{className:"text-xs",children:[(0,s.jsx)(f.Z,{className:"inline h-3 w-3 mr-1 text-gray-500"}),"Local do Plant\xe3o: ",t.locationCity,", ",t.locationState]})]}),(0,s.jsxs)(n.aY,{className:"text-sm space-y-2 pt-4",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)(g.Z,{size:14,className:"mr-2 text-gray-500"}),(0,s.jsx)("strong",{children:"Data:"}),(0,s.jsx)("span",{className:"ml-1",children:l.toLocaleDateString("pt-BR")})]}),(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)(v.Z,{size:14,className:"mr-2 text-gray-500"}),(0,s.jsx)("strong",{children:"Hor\xe1rio Esperado:"}),(0,s.jsxs)("span",{className:"ml-1",children:[t.expectedStartTime," - ",t.expectedEndTime]})]}),u&&t.patientName&&(0,s.jsxs)("div",{className:"mt-3 pt-3 border-t border-dashed",children:[(0,s.jsx)("h4",{className:"text-xs font-semibold text-gray-500 mb-2",children:"Paciente Agendado"}),(0,s.jsxs)("div",{className:"p-3 bg-blue-50 rounded-md border border-blue-200 space-y-1",children:[(0,s.jsxs)("div",{className:"flex items-center font-semibold text-blue-900",children:[(0,s.jsx)(N.Z,{size:14,className:"mr-2"}),t.patientName]}),(0,s.jsx)("p",{className:"text-xs text-gray-700 pl-6",children:t.chiefComplaint})]})]}),t.checkinAt&&(0,s.jsxs)("div",{className:"pt-2 space-y-1",children:[(0,s.jsxs)("div",{className:"text-xs text-green-700 flex items-center",children:[(0,s.jsx)(j.Z,{size:13,className:"mr-1.5"}),"Check-in realizado \xe0s ",t.checkinAt.toDate().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})]}),t.checkinLocation&&(0,s.jsx)(T,{location:t.checkinLocation})]}),t.checkoutAt&&(0,s.jsxs)("div",{className:"pt-2 space-y-1",children:[(0,s.jsxs)("div",{className:"text-xs text-red-700 flex items-center",children:[(0,s.jsx)(b.Z,{size:13,className:"mr-1.5"}),"Check-out realizado \xe0s ",t.checkoutAt.toDate().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})]}),t.checkoutLocation&&(0,s.jsx)(T,{location:t.checkoutLocation})]})]}),(0,s.jsxs)(n.eW,{className:"flex justify-end gap-2 border-t pt-4",children:[h&&(0,s.jsxs)(i.z,{onClick:()=>o(t.contractId),size:"sm",className:"bg-blue-600 hover:bg-blue-700",disabled:m,children:[m&&(0,s.jsx)(d.Z,{className:"mr-2 h-4 w-4 animate-spin"}),(0,s.jsx)(y.Z,{className:"mr-2 h-4 w-4"})," Iniciar Atendimento"]}),x&&(0,s.jsxs)(i.z,{onClick:a,size:"sm",className:"bg-blue-600 hover:bg-blue-700",disabled:m,children:[m&&(0,s.jsx)(d.Z,{className:"mr-2 h-4 w-4 animate-spin"}),(0,s.jsx)(j.Z,{className:"mr-2 h-4 w-4"})," Fazer Check-in"]}),p&&(0,s.jsxs)(i.z,{onClick:()=>r(t.id),size:"sm",variant:"outline",disabled:m,children:[m&&(0,s.jsx)(d.Z,{className:"mr-2 h-4 w-4 animate-spin"}),(0,s.jsx)(b.Z,{className:"mr-2 h-4 w-4"})," Fazer Check-out"]}),w&&(0,s.jsx)(I.C,{variant:"default",className:"bg-green-100 text-green-800",children:"Plant\xe3o Finalizado"})]})]})}},26110:function(e,t,a){"use strict";a.d(t,{$N:function(){return f},Be:function(){return g},GG:function(){return m},Vq:function(){return c},cN:function(){return p},cZ:function(){return h},fK:function(){return x},hg:function(){return l}});var s=a(57437),r=a(2265),o=a(49027),i=a(32489),n=a(94508);let c=o.fC,l=o.xz,d=o.h_,m=o.x8,u=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(o.aV,{ref:t,className:(0,n.cn)("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...r})});u.displayName=o.aV.displayName;let h=r.forwardRef((e,t)=>{let{className:a,children:r,...c}=e;return(0,s.jsxs)(d,{children:[(0,s.jsx)(u,{}),(0,s.jsxs)(o.VY,{ref:t,className:(0,n.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...c,children:[r,(0,s.jsxs)(o.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,s.jsx)(i.Z,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});h.displayName=o.VY.displayName;let x=e=>{let{className:t,...a}=e;return(0,s.jsx)("div",{className:(0,n.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...a})};x.displayName="DialogHeader";let p=e=>{let{className:t,...a}=e;return(0,s.jsx)("div",{className:(0,n.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...a})};p.displayName="DialogFooter";let f=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(o.Dx,{ref:t,className:(0,n.cn)("text-lg font-semibold leading-none tracking-tight",a),...r})});f.displayName=o.Dx.displayName;let g=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(o.dk,{ref:t,className:(0,n.cn)("text-sm text-muted-foreground",a),...r})});g.displayName=o.dk.displayName},15822:function(e,t,a){"use strict";a.d(t,{v:function(){return o}});var s=a(60062),r=a(17293);let o=async(e,t,a)=>new Promise((o,i)=>{let n=(0,s.iH)(r.tO,t),c=(0,s.B0)(n,e);c.on("state_changed",t=>{let s=t.bytesTransferred/t.totalBytes*100;a&&a(s),console.log("[StorageService] Upload de ".concat(e.name," est\xe1 ").concat(s,"% done"))},e=>{console.error("[StorageService] Falha no upload:",e);let t="Erro desconhecido no upload do arquivo.";switch(e.code){case"storage/unauthorized":t="Permiss\xe3o negada. Verifique as regras do Storage.";break;case"storage/canceled":t="Upload cancelado.";break;default:t="Erro no upload: ".concat(e.message)}i(Error(t))},async()=>{try{let t=await (0,s.Jt)(c.snapshot.ref);console.log("[StorageService] Arquivo ".concat(e.name," dispon\xedvel em"),t),o(t)}catch(e){console.error("[StorageService] Erro ao obter URL de download:",e),i(Error("Falha ao obter URL de download ap\xf3s o upload."))}})})}},function(e){e.O(0,[4358,9990,6137,9084,9733,6838,6404,7121,2971,2117,1744],function(){return e(e.s=12326)}),_N_E=e.O()}]);